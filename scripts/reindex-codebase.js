#!/usr/bin/env node
import { promises as fs } from 'node:fs';
import path from 'node:path';

const REPOSITORY_ROOT = process.cwd();
const BACKEND_JSON_RELATIVE = 'backend-index.json';
const BACKEND_MD_RELATIVE = path.join('docs', 'BACKEND_INDEX.md');
const CLI_AGENT_JSON_RELATIVE = 'cli-agent-index.json';
const CLI_AGENT_MD_RELATIVE = path.join('docs', 'CLI_AGENT_INDEX.md');

// Output paths for Backend (TS)
const BACKEND_JSON_PATH = path.join(REPOSITORY_ROOT, BACKEND_JSON_RELATIVE);
const BACKEND_MD_PATH = path.join(REPOSITORY_ROOT, BACKEND_MD_RELATIVE);

// Output paths for CLI Agent (Python)
const CLI_AGENT_JSON_PATH = path.join(REPOSITORY_ROOT, CLI_AGENT_JSON_RELATIVE);
const CLI_AGENT_MD_PATH = path.join(REPOSITORY_ROOT, CLI_AGENT_MD_RELATIVE);

const EXCLUDED_DIRS = [
  'node_modules',
  '.git',
  'dist',
  'build',
  'coverage',
  '.venv',
  '__pycache__',
  'converge-artifacts',
  'npm_logs',
  'logs',
  'workspace-backup',
  '.claude',
  '.workspace',
  'docs' // Don't index the indices themselves
];

/**
 * Recursively collects files by extension, excluding certain directories.
 */
async function collectFiles(dir, extensions, allFiles = []) {
  const entries = await fs.readdir(dir, { withFileTypes: true });

  for (const entry of entries) {
    const res = path.resolve(dir, entry.name);
    if (entry.isDirectory()) {
      if (EXCLUDED_DIRS.includes(entry.name)) continue;
      await collectFiles(res, extensions, allFiles);
    } else {
      if (extensions.some(ext => entry.name.endsWith(ext))) {
        allFiles.push(res);
      }
    }
  }
  return allFiles;
}

/**
 * Groups files by their top-level directory (scope).
 */
function groupFiles(files) {
  const groups = {};
  for (const file of files) {
    const relative = path.relative(REPOSITORY_ROOT, file).split(path.sep).join('/');
    const scope = relative.split('/')[0] || 'root';
    if (!groups[scope]) groups[scope] = [];
    groups[scope].push({
      relativePath: relative
    });
  }
  
  return Object.keys(groups).sort().map(scope => ({
    scope,
    files: groups[scope].sort((a, b) => a.relativePath.localeCompare(b.relativePath))
  }));
}
function renderMarkdown(title, groupedEntries, generatorScript) {
  const generatedTimestamp = new Date().toISOString();
  const lines = [
    `# ${title}`,
    '',
    `Generated by node ${generatorScript}.`,
    '',
    `Generated at: ${generatedTimestamp}`,
    '',
    'This index is copy-path friendly for IDE navigation and shell usage.',
    ''
  ];

  for (const group of groupedEntries) {
    lines.push(`## ${group.scope}`);
    lines.push('');
    lines.push('| Relative path |');
    lines.push('| --- |');
    for (const file of group.files) {
      lines.push(`| \`${file.relativePath}\` |`);
    }
    lines.push('');
  }

  return lines.join('\n');
}

async function run() {
  console.log('[reindex] Starting codebase re-indexing...');

  // 1. Collect and group TypeScript files (Backend)
  console.log('[reindex] Indexing TypeScript files...');
  const tsFiles = await collectFiles(REPOSITORY_ROOT, ['.ts']);
  const groupedTs = groupFiles(tsFiles);
  
  // 2. Collect and group Python files (CLI Agent)
  console.log('[reindex] Indexing Python files...');
  const pyFiles = await collectFiles(REPOSITORY_ROOT, ['.py']);
  const groupedPy = groupFiles(pyFiles);

  // 3. Write Backend artifacts
  await fs.writeFile(BACKEND_JSON_PATH, JSON.stringify({ generatedAt: new Date().toISOString(), scopes: groupedTs }, null, 2));
  await fs.writeFile(BACKEND_MD_PATH, renderMarkdown('Backend Index (TypeScript)', groupedTs, 'scripts/reindex-codebase.js'));

  // 4. Write CLI Agent artifacts
  await fs.writeFile(CLI_AGENT_JSON_PATH, JSON.stringify({ generatedAt: new Date().toISOString(), scopes: groupedPy }, null, 2));
  await fs.writeFile(CLI_AGENT_MD_PATH, renderMarkdown('CLI Agent Index (Python)', groupedPy, 'scripts/reindex-codebase.js'));

  console.log(`[reindex] Success!`);
  console.log(`[reindex] Backend: ${tsFiles.length} files -> ${BACKEND_JSON_RELATIVE}`);
  console.log(`[reindex] CLI Agent: ${pyFiles.length} files -> ${CLI_AGENT_JSON_RELATIVE}`);
}

run().catch(err => {
  console.error('[reindex] Failed:', err);
  process.exit(1);
});
