name: ARCANOS PR Assistant

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to analyze'
        required: true
        type: string

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

jobs:
  arcanos-pr-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üß∞ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.11.1'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üßπ Lint code
        run: npm run lint

      - name: üîß Build project
        run: npm run build

      - name: üß™ Run tests
        continue-on-error: true
        run: npm test

      - name: üîß Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y

      - name: üìä Get PR details
        id: pr-details
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          
          # Get PR diff
          gh pr diff $PR_NUMBER > pr.diff || echo "" > pr.diff
          
          # Get changed files
          gh pr view $PR_NUMBER --json files --jq '.files[].path' > changed_files.txt || echo "" > changed_files.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ü§ñ Run ARCANOS PR Analysis
        id: analysis
        run: |
          echo "Starting ARCANOS PR analysis..."
          
          # Set environment variables
          export PORT=8080
          export NODE_ENV=production
          export OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
          
          # Start the ARCANOS server in background
          npm start > server.log 2>&1 &
          SERVER_PID=$!
          
          # Wait for server to be ready with retries
          echo "Waiting for server to start..."
          MAX_RETRIES=30
          RETRY_COUNT=0
          SERVER_READY=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s http://localhost:8080/health > /dev/null 2>&1; then
              echo "Server is ready!"
              SERVER_READY=true
              break
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Waiting for server... ($RETRY_COUNT/$MAX_RETRIES)"
            sleep 2
          done
          
          if [ "$SERVER_READY" = false ]; then
            echo "‚ùå Server failed to start. Logs:"
            cat server.log
            exit 1
          fi
          
          # Prepare analysis request
          PR_DIFF=$(cat pr.diff | jq -Rs . || echo '""')
          PR_FILES=$(cat changed_files.txt | jq -Rs 'split("\n") | map(select(. != ""))' || echo '[]')
          
          # Run PR analysis
          echo "Running PR analysis..."
          HTTP_CODE=$(curl -X POST http://localhost:8080/api/pr-analysis/analyze \
            -H "Content-Type: application/json" \
            -d "{
              \"prDiff\": $PR_DIFF,
              \"prFiles\": $PR_FILES,
              \"metadata\": {
                \"prNumber\": ${{ steps.pr-details.outputs.pr_number }},
                \"repository\": \"${{ github.repository }}\"
              }
            }" \
            -w "%{http_code}" \
            -o analysis_result.json \
            -s)
          
          # Stop the server
          kill $SERVER_PID 2>/dev/null || true
          sleep 2
          kill -9 $SERVER_PID 2>/dev/null || true
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå PR analysis failed with HTTP code: $HTTP_CODE"
            echo "Response:"
            cat analysis_result.json || echo "No response body"
            exit 1
          fi
          
          # Extract markdown output
          jq -r '.markdown // "Analysis completed"' analysis_result.json > analysis_report.md || echo "Analysis completed" > analysis_report.md
          
          # Extract status for step output
          STATUS=$(jq -r '.result.status // "‚ö†Ô∏è"' analysis_result.json)
          echo "analysis_status=$STATUS" >> $GITHUB_OUTPUT
          
          echo "Analysis completed with status: $STATUS"

      - name: üìù Post PR Comment
        if: always() && steps.analysis.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            try {
              if (!fs.existsSync('analysis_report.md')) {
                console.log('No analysis report found, skipping comment');
                return;
              }
              
              const analysisReport = fs.readFileSync('analysis_report.md', 'utf8');
              const prNumber = parseInt('${{ steps.pr-details.outputs.pr_number }}');
              
              if (!prNumber || isNaN(prNumber)) {
                console.log('Invalid PR number, skipping comment');
                return;
              }
              
              // Check if we already have an ARCANOS comment
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber
              });
              
              const existingComment = comments.data.find(comment => 
                comment.body.includes('ü§ñ ARCANOS PR Analysis Report') ||
                comment.body.includes('ARCANOS PR Analysis')
              );
              
              const commentBody = `${analysisReport}\n\n---\n*Analysis triggered by: ${context.actor}*\n*Workflow run: [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})*`;
              
              if (existingComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: commentBody
                });
                console.log('Updated existing ARCANOS analysis comment');
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: commentBody
                });
                console.log('Created new ARCANOS analysis comment');
              }
            } catch (error) {
              console.error('Error posting PR comment:', error);
              // Don't fail the workflow if comment posting fails
            }

      - name: üö® Create Issue for Critical Findings
        if: always() && steps.analysis.outcome == 'success' && steps.analysis.outputs.analysis_status == '‚ùå'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            try {
              if (!fs.existsSync('analysis_report.md')) {
                console.log('No analysis report found, skipping issue creation');
                return;
              }
              
              const analysisReport = fs.readFileSync('analysis_report.md', 'utf8');
              const prNumber = parseInt('${{ steps.pr-details.outputs.pr_number }}');
              
              if (!prNumber || isNaN(prNumber)) {
                console.log('Invalid PR number, skipping issue creation');
                return;
              }
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üö® ARCANOS: Critical Issues in PR #${prNumber}`,
                body: `Critical issues detected by ARCANOS PR Assistant in PR #${prNumber}.\n\n${analysisReport}\n\n[View PR #${prNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/pull/${prNumber})`,
                labels: ['arcanos', 'critical', 'pr-analysis', 'needs-attention']
              });
              
              console.log('Created critical issues tracking issue');
            } catch (error) {
              console.error('Error creating issue:', error);
              // Don't fail the workflow if issue creation fails
            }

      - name: üíæ Upload Analysis Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: arcanos-pr-analysis-${{ steps.pr-details.outputs.pr_number }}
          path: |
            analysis_result.json
            analysis_report.md
            pr.diff
            changed_files.txt
          retention-days: 30

      - name: üìä Set Check Status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.analysis.outputs.analysis_status }}' || 'unknown';
            const prNumber = parseInt('${{ steps.pr-details.outputs.pr_number }}') || 0;
            const analysisOutcome = '${{ steps.analysis.outcome }}';
            
            let checkStatus, summary;
            
            if (analysisOutcome !== 'success') {
              checkStatus = 'failure';
              summary = 'ARCANOS analysis workflow failed';
            } else {
              switch(status) {
                case '‚úÖ':
                  checkStatus = 'success';
                  summary = 'All ARCANOS checks passed - Ready for merge';
                  break;
                case '‚ö†Ô∏è':
                  checkStatus = 'neutral';
                  summary = 'ARCANOS found minor issues - Review recommended';
                  break;
                case '‚ùå':
                  checkStatus = 'failure';
                  summary = 'ARCANOS found critical issues - Fixes required';
                  break;
                default:
                  checkStatus = 'failure';
                  summary = 'ARCANOS analysis completed with unknown status';
              }
            }
            
            try {
              await github.rest.checks.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'ARCANOS PR Assistant',
                head_sha: context.sha,
                status: 'completed',
                conclusion: checkStatus,
                output: {
                  title: 'ARCANOS PR Analysis',
                  summary: summary,
                  text: `PR #${prNumber} analysis completed with status: ${status}`
                }
              });
              
              console.log(`Set check status to: ${checkStatus}`);
            } catch (error) {
              console.error('Error setting check status:', error);
              // Don't fail the workflow if check creation fails
            }

      - name: üéØ Analysis Summary
        run: |
          echo "## ü§ñ ARCANOS PR Analysis Summary"
          echo "**PR Number:** ${{ steps.pr-details.outputs.pr_number }}"
          echo "**Status:** ${{ steps.analysis.outputs.analysis_status }}"
          echo "**Repository:** ${{ github.repository }}"
          echo "**Analysis completed at:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          
          if [ -f analysis_result.json ]; then
            echo ""
            echo "**Key Findings:**"
            jq -r '.result.recommendations[] | "- " + .' analysis_result.json | head -5
          fi