# Authoritative required workflow for branch protection checks.
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '20.11.1'
  OPENAI_API_KEY: 'mock-api-key'

jobs:
  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ›¡ï¸ Commit guardrails
        run: npm run guard:commit

      - name: ğŸ”§ Type check
        run: npm run type-check

      - name: ğŸ§¹ Lint code
        run: npm run lint

  build:
    name: Build (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck]

    strategy:
      matrix:
        node-version: ['18.x', '20.11.1']

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”¨ Build project
        run: npm run build

      - name: ğŸ“Š Upload build artifacts
        if: matrix.node-version == '20.11.1'
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 1

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck]
    
    strategy:
      matrix:
        test-type: [unit, integration]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”¨ Build project
        run: npm run build

      - name: ğŸ§ª Run unit tests
        if: matrix.test-type == 'unit'
        run: npm test

      - name: ğŸ“Š Upload Node coverage to Codecov
        if: matrix.test-type == 'unit'
        uses: codecov/codecov-action@v5
        with:
          files: coverage/lcov.info
          flags: node
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: ğŸ”Œ Run integration tests
        if: matrix.test-type == 'integration'
        run: |
          # Set minimal environment for testing
          export OPENAI_API_KEY=mock-api-key
          export NODE_ENV=test
          export PORT=0
          npm run test:integration || echo "Integration tests not yet implemented"

  validate-railway-compatibility:
    name: Railway Compatibility
    runs-on: ubuntu-latest
    needs: [build]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”¨ Build project
        run: npm run build

      - name: ğŸš„ Validate Railway compatibility
        run: node validate-railway-compatibility.js

      - name: ğŸ³ Test Docker build
        run: |
          docker build -t arcanos-test .
          echo "âœ… Docker build successful"

  validate-deployment-readiness:
    name: Deployment Readiness
    runs-on: ubuntu-latest
    needs: [build, test, validate-railway-compatibility]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: dist/

      - name: ğŸš€ Test server startup
        run: |
          export NODE_ENV=production
          export PORT=8080
          export OPENAI_API_KEY=mock-api-key
          timeout 30s npm start &
          SERVER_PID=$!
          
          # Wait for server to start
          sleep 10
          
          # Test health endpoint
          curl -f http://localhost:8080/health || exit 1
          
          # Kill server
          kill $SERVER_PID || true
          
          echo "âœ… Server starts successfully and responds to health checks"

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”’ Run npm security audit
        run: npm audit --audit-level=moderate

      - name: ğŸ“œ License compliance check
        run: npx license-checker --production --failOn "GPL-3.0;AGPL-3.0"

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ”’ Run Python dependency audit
        run: |
          pip install pip-audit
          pip-audit -r daemon-python/requirements.txt

  sdk-compliance-audit:
    name: Convergence Gate
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”¨ Build project
        run: npm run build

      - name: â™»ï¸ Run convergence gate
        run: npm run converge:ci

      - name: ğŸ“Š Upload convergence artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: converge-artifacts
          path: converge-artifacts/
          if-no-files-found: ignore
          retention-days: 30

  python-cli-windows:
    name: Python CLI (Windows)
    runs-on: windows-latest
    needs: [lint-and-typecheck]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install openai requests python-dotenv tenacity sentry-sdk pytest pytest-mock

      - name: ğŸ§ª Validate CLI offline contract
        run: python daemon-python/validate_backend_cli_offline.py

      - name: ğŸ§ª Run Python unit tests with coverage
        run: |
          pip install pytest-cov
          pytest daemon-python/tests/ -q --cov=daemon-python/arcanos --cov-report=xml:coverage-python.xml

      - name: ğŸ“Š Upload Python coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: coverage-python.xml
          flags: python
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  all-checks-complete:
    name: All Checks Complete
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, build, test, validate-railway-compatibility, validate-deployment-readiness, security-audit, sdk-compliance-audit, python-cli-windows]
    
    steps:
      - name: âœ… All checks passed
        run: |
          echo "ğŸ‰ All CI/CD checks have passed successfully!"
          echo "âœ… Linting and type checking"
          echo "âœ… Build process"
          echo "âœ… Test suite"
          echo "âœ… Railway compatibility"
          echo "âœ… Deployment readiness"
          echo "âœ… Security audit"
          echo "âœ… Convergence gate"
          echo ""
          echo "ğŸš€ Repository is ready for production deployment!"
