name: Build and Release (Deprecated - Windows builds removed)

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Release tag name (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  # Windows executable build job disabled - Windows builds deprecated
  # CLI agent now runs as Python application
  build-windows-executables:
    name: Build Windows Executables (Deprecated)
    runs-on: windows-latest
    if: false  # Disabled - Windows builds deprecated
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üì¶ Install Python dependencies
        run: |
          cd daemon-python
          pip install -r requirements.txt
        shell: pwsh

      - name: üî® Build Windows executables
        run: |
          cd daemon-python
          ./build_windows.ps1
        shell: pwsh

      - name: üìã Verify build outputs
        run: |
          cd daemon-python
          if (Test-Path "dist/ARCANOS.exe") {
            Write-Host "‚úÖ ARCANOS.exe built successfully"
            $size = (Get-Item "dist/ARCANOS.exe").Length
            Write-Host "   Size: $([math]::Round($size/1MB, 2)) MB"
          } else {
            Write-Host "‚ùå ARCANOS.exe not found"
            exit 1
          }
          if (Test-Path "dist/daemon.exe") { Write-Host "‚úÖ daemon.exe" }
          if (Test-Path "dist/cli.exe") { Write-Host "‚úÖ cli.exe" }
        shell: pwsh

      - name: üì¶ Install Inno Setup and build installer
        run: |
          choco install innosetup -y
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "installer\ARCANOS.iss"
          if (-not (Test-Path "installer\dist\ARCANOS-Setup.exe")) { Write-Error "ARCANOS-Setup.exe not found"; exit 1 }
          Write-Host "‚úÖ ARCANOS-Setup.exe built"
        shell: pwsh

      - name: üîê Generate checksums
        run: |
          cd daemon-python/dist
          $daemonHash = (Get-FileHash daemon.exe -Algorithm SHA256).Hash
          $cliHash = (Get-FileHash cli.exe -Algorithm SHA256).Hash
          $arcanosHash = (Get-FileHash ARCANOS.exe -Algorithm SHA256).Hash
          "SHA256 Checksums" | Out-File -FilePath checksums.txt -Encoding utf8
          "================" | Out-File -FilePath checksums.txt -Encoding utf8 -Append
          "daemon.exe: $daemonHash" | Out-File -FilePath checksums.txt -Encoding utf8 -Append
          "cli.exe: $cliHash" | Out-File -FilePath checksums.txt -Encoding utf8 -Append
          "ARCANOS.exe: $arcanosHash" | Out-File -FilePath checksums.txt -Encoding utf8 -Append
          cd ../..
          $setupHash = (Get-FileHash "installer\dist\ARCANOS-Setup.exe" -Algorithm SHA256).Hash
          "ARCANOS-Setup.exe: $setupHash" | Out-File -FilePath daemon-python/dist/checksums.txt -Encoding utf8 -Append
          Write-Host "Checksums: daemon.exe, cli.exe, ARCANOS.exe, ARCANOS-Setup.exe"
        shell: pwsh

      - name: üè∑Ô∏è Determine release tag
        id: get_tag
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $tag = "${{ inputs.tag_name }}"
          } else {
            $tag = "${{ github.ref_name }}"
          }
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          Write-Host "Release tag: $tag"
        shell: pwsh

      - name: üì¶ Get PyInstaller version for release notes
        id: build_info
        run: |
          cd daemon-python
          try {
            $version = pip show pyinstaller | Select-String "Version:" | ForEach-Object { $_.ToString().Split(":")[1].Trim() }
            if ([string]::IsNullOrWhiteSpace($version)) {
              $version = "unknown"
            }
            echo "pyinstaller_version=$version" >> $env:GITHUB_OUTPUT
          } catch {
            Write-Host "Warning: Could not retrieve PyInstaller version"
            echo "pyinstaller_version=unknown" >> $env:GITHUB_OUTPUT
          }
        shell: pwsh

      - name: üìù Generate release notes
        id: release_notes
        run: |
          $tag = "${{ steps.get_tag.outputs.tag }}"
          
          # Read checksums
          if (-not (Test-Path "daemon-python/dist/checksums.txt")) {
            Write-Error "Checksums file not found. Build may have failed."
            exit 1
          }
          $checksums = Get-Content daemon-python/dist/checksums.txt -Raw
          
          $notes = @"
          # ARCANOS Daemon Release $tag
          
          ## Application / Downloads
          
          - **ARCANOS-Setup.exe** ‚Äî Installer (recommended; creates desktop shortcut)
          - **ARCANOS.exe** ‚Äî Portable executable
          
          ## üì¶ Windows Executables (dev/legacy)
          
          - **daemon.exe** ‚Äî Background service for periodic memory synchronization
          - **cli.exe** ‚Äî Command-line interface for reading and writing daemon memory
          
          ## üöÄ Quick Start
          
          1. Download **ARCANOS-Setup.exe** or **ARCANOS.exe** from the assets below
          2. Run **ARCANOS-Setup.exe** to install (recommended), or run **ARCANOS.exe** portable
          3. For daemon/CLI: run `daemon.exe` or use `cli.exe read` / `cli.exe write`
          
          ## üìã Requirements
          
          - Windows 10 or later
          - No additional dependencies required (executables are self-contained)
          
          ## üîê Checksums
          
          ```
          $checksums
          ```
          
          ## üîß Build Information
          
          - Built with PyInstaller ${{ steps.build_info.outputs.pyinstaller_version }}
          - Python runtime: 3.11
          - Build date: $((Get-Date).ToUniversalTime().ToString('yyyy-MM-dd HH:mm:ss')) UTC
          
          ---
          
          *Generated automatically by GitHub Actions*
          "@
          
          # Save to file for release creation
          $notes | Out-File -FilePath release_notes.md -Encoding utf8
          Write-Host "Release notes generated"
        shell: pwsh

      - name: üöÄ Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          name: ARCANOS Daemon ${{ steps.get_tag.outputs.tag }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            daemon-python/dist/ARCANOS.exe
            installer/dist/ARCANOS-Setup.exe
            daemon-python/dist/daemon.exe
            daemon-python/dist/cli.exe
            daemon-python/dist/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ‚úÖ Release complete
        run: |
          Write-Host "üéâ Release ${{ steps.get_tag.outputs.tag }} created successfully!"
          Write-Host "üì¶ Uploaded assets:"
          Write-Host "   - ARCANOS-Setup.exe (installer)"
          Write-Host "   - ARCANOS.exe (portable)"
          Write-Host "   - daemon.exe, cli.exe, checksums.txt"
          Write-Host ""
          Write-Host "üîó View release: ${{ steps.create_release.outputs.url }}"
        shell: pwsh
