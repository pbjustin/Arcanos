name: Build and Release Windows Executables

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Release tag name (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-windows-executables:
    name: Build Windows Executables
    runs-on: windows-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install Python dependencies
        run: |
          cd daemon-python
          pip install -r requirements.txt
        shell: pwsh

      - name: ğŸ”¨ Build Windows executables
        run: |
          cd daemon-python
          ./build_windows.ps1
        shell: pwsh

      - name: ğŸ“‹ Verify build outputs
        run: |
          cd daemon-python
          if (Test-Path "dist/daemon.exe") {
            Write-Host "âœ… daemon.exe built successfully"
            $daemonSize = (Get-Item "dist/daemon.exe").Length
            Write-Host "   Size: $([math]::Round($daemonSize/1MB, 2)) MB"
          } else {
            Write-Host "âŒ daemon.exe not found"
            exit 1
          }
          
          if (Test-Path "dist/cli.exe") {
            Write-Host "âœ… cli.exe built successfully"
            $cliSize = (Get-Item "dist/cli.exe").Length
            Write-Host "   Size: $([math]::Round($cliSize/1MB, 2)) MB"
          } else {
            Write-Host "âŒ cli.exe not found"
            exit 1
          }
        shell: pwsh

      - name: ğŸ” Generate checksums
        run: |
          cd daemon-python/dist
          $daemonHash = (Get-FileHash daemon.exe -Algorithm SHA256).Hash
          $cliHash = (Get-FileHash cli.exe -Algorithm SHA256).Hash
          
          Write-Host "Checksums generated:"
          Write-Host "  daemon.exe: $daemonHash"
          Write-Host "  cli.exe: $cliHash"
          
          # Save checksums to file
          @"
          SHA256 Checksums
          ================
          daemon.exe: $daemonHash
          cli.exe: $cliHash
          "@ | Out-File -FilePath checksums.txt -Encoding utf8
          
          Write-Host ""
          Write-Host "Checksums saved to checksums.txt"
        shell: pwsh

      - name: ğŸ·ï¸ Determine release tag
        id: get_tag
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $tag = "${{ inputs.tag_name }}"
          } else {
            $tag = "${{ github.ref_name }}"
          }
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          Write-Host "Release tag: $tag"
        shell: pwsh

      - name: ğŸ“¦ Get PyInstaller version for release notes
        id: build_info
        run: |
          cd daemon-python
          try {
            $version = pip show pyinstaller | Select-String "Version:" | ForEach-Object { $_.ToString().Split(":")[1].Trim() }
            if ([string]::IsNullOrWhiteSpace($version)) {
              $version = "unknown"
            }
            echo "pyinstaller_version=$version" >> $env:GITHUB_OUTPUT
          } catch {
            Write-Host "Warning: Could not retrieve PyInstaller version"
            echo "pyinstaller_version=unknown" >> $env:GITHUB_OUTPUT
          }
        shell: pwsh

      - name: ğŸ“ Generate release notes
        id: release_notes
        run: |
          $tag = "${{ steps.get_tag.outputs.tag }}"
          
          # Read checksums
          $checksums = Get-Content daemon-python/dist/checksums.txt -Raw
          
          $notes = @"
          # ARCANOS Daemon Release $tag
          
          ## ğŸ“¦ Windows Executables
          
          This release includes pre-built Windows executables for the ARCANOS daemon and CLI tools:
          
          - **daemon.exe** - Background service for periodic memory synchronization
          - **cli.exe** - Command-line interface for reading and writing daemon memory
          
          ## ğŸš€ Quick Start
          
          1. Download the executables from the assets below
          2. Place them in your desired directory
          3. Run ``daemon.exe`` to start the background service
          4. Use ``cli.exe read <key>`` or ``cli.exe write <key> <value>`` to interact with memory
          
          ## ğŸ“‹ Requirements
          
          - Windows 10 or later
          - No additional dependencies required (executables are self-contained)
          
          ## ğŸ” Checksums
          
          ``````
          $checksums
          ``````
          
          ## ğŸ”§ Build Information
          
          - Built with PyInstaller ${{ steps.build_info.outputs.pyinstaller_version }}
          - Python runtime: 3.11
          - Build date: $((Get-Date).ToUniversalTime().ToString('yyyy-MM-dd HH:mm:ss')) UTC
          
          ---
          
          *Generated automatically by GitHub Actions*
          "@
          
          # Save to file for release creation
          $notes | Out-File -FilePath release_notes.md -Encoding utf8
          Write-Host "Release notes generated"
        shell: pwsh

      - name: ğŸš€ Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          name: ARCANOS Daemon ${{ steps.get_tag.outputs.tag }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            daemon-python/dist/daemon.exe
            daemon-python/dist/cli.exe
            daemon-python/dist/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Release complete
        run: |
          Write-Host "ğŸ‰ Release ${{ steps.get_tag.outputs.tag }} created successfully!"
          Write-Host "ğŸ“¦ Uploaded assets:"
          Write-Host "   - daemon.exe"
          Write-Host "   - cli.exe"
          Write-Host "   - checksums.txt"
          Write-Host ""
          Write-Host "ğŸ”— View release: ${{ steps.create_release.outputs.url }}"
        shell: pwsh
